
<!DOCTYPE html>
<html>
<head>
    <title>Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .filter-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .filter-group {
            margin: 10px 0;
        }
        select, input[type="date"] {
            padding: 5px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .charts-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .chart {
            width: 48%;
        }
    </style>
</head>
<body>
    <h1>Sales Dashboard</h1>

    <div class="filter-section">
        <form method="get">
            <div class="filter-group">
                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" name="start_date" value="{{ selected_start_date }}">

                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" name="end_date" value="{{ selected_end_date }}">
            </div>

            <div class="filter-group">
                <label for="salesperson">Salesperson:</label>
                <select name="salesperson" id="salesperson">
                    <option value="">All Salespeople</option>
                    {% for person in salespeople %}
                        <option value="{{ person }}" {% if selected_salesperson == person %}selected{% endif %}>
                            {{ person }}
                        </option>
                    {% endfor %}
                </select>

                <label for="product_name">Product:</label>
            <select name="product_name" id="product_name">
                <option value="">All Products</option>
                {% for product in products %}
                <option value="{{ product.id }}" {% if selected_product == product.id %} selected {% endif %}>
                    {{ product.product_name }}
                </option>
                {% endfor %}
            </select>

            </div>

            <button type="submit">Apply Filters</button>
            <button type="button" onclick="window.location.href='{% url 'dashboard' %}'">Reset Filters</button>
        </form>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
        <p>Total Revenue: ${{ total_revenue|floatformat:2 }}</p>
        <p>Total Sales: {{ total_sales }}</p>

        <h2>Top Selling Products</h2>
        <ul>
            {% for product in top_products %}
                <li>{{ product.product__product_name }}: {{ product.total_sold }} units</li>
            {% endfor %}
        </ul>
        


        <h3>Low-Stock Products</h3>
<ul>
    {% for product in low_stock_products %}
        <li>{{ product.product_name }} - Quantity in Stock: {{ product.quantity_in_stock }}</li>
    {% endfor %}
</ul>

        <!-- Charts -->
        <div class="charts-container">
            <!-- Bar Chart for Top Selling Products -->
            <div class="chart">
                <canvas id="salesBarChart"></canvas>
            </div>

            <!-- Line Chart for Sales Over Time -->
            <div class="chart">
                <canvas id="salesLineChart"></canvas>
            </div>
        </div>

        <!-- Total Revenue Chart for the Current Month -->
        <div class="chart">
            <h2>Total Revenue for Current Month</h2>
            <canvas id="revenueChart"></canvas>
        </div>

        <div class="chart">
            <canvas id="salesPieChart"></canvas>
        </div>

        <!-- Total Sales -->
        <div class="chart">
            <h3>Total Sales</h3>
            <canvas id="totalSalesChart"></canvas>
        </div>
        
    </div>

    <script>
        // Initialize date pickers
        flatpickr("#start_date", {
            dateFormat: "Y-m-d"
        });
        flatpickr("#end_date", {
            dateFormat: "Y-m-d"
        });

        // Bar Chart Initialization (Top Selling Products)
        var barCtx = document.getElementById('salesBarChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: [{% for product in top_products %}"{{ product.product__product_name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Units Sold',
                    data: [{% for product in top_products %}{{ product.total_sold }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Line Chart Initialization (Sales Over Time)
        var lineCtx = document.getElementById('salesLineChart').getContext('2d');
        new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: [{% for product in top_products %}"{{ product.product__product_name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Units Sold Over Time',
                    data: [{% for product in top_products %}{{ product.total_sold }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#ff6347',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Revenue Chart Initialization for Current Month
        var revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: ["Week 1", "Week 2", "Week 3", "Week 4"],
                datasets: [{
                    label: 'Revenue for Current Month',
                    data: [{{ revenue_week_1 }}, {{ revenue_week_2 }}, {{ revenue_week_3 }}, {{ revenue_week_4 }}],
                    borderColor: '#28a745',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Pie Chart Initialization (Revenue Breakdown by Salesperson)
        var pieCtx = document.getElementById('salesPieChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: [{% for salesperson in salesperson_revenue %}"{{ salesperson.salesperson }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for salesperson in salesperson_revenue %}{{ salesperson.revenue }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: ['#ff9999', '#66b3ff', '#99ff99', '#ffcc99', '#c2c2f0'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Revenue Breakdown by Salesperson',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.label + ': $' + tooltipItem.raw.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Total Sales Chart
        var totalSalesCtx = document.getElementById('totalSalesChart').getContext('2d');
        new Chart(totalSalesCtx, {
            type: 'bar',
            data: {
                labels: [{% for sale in total_sales_data %}"{{ sale.date_of_sale }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Total Sales Count',
                    data: [{% for sale in total_sales_data %}{{ sale.sales_count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: '#28a745',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</body>

</html>






# from django.db.models import Sum
# from datetime import datetime

# def dashboard(request):
#     today = datetime.today()
#     sales_data = SalesRecord.objects.filter(date_of_sale__year=today.year, date_of_sale__month=today.month)

#     total_revenue = sales_data.aggregate(Sum('total_price'))['total_price__sum'] or 0
#     total_sales = sales_data.count()
#     top_products = sales_data.values('product_name').annotate(total_sold=Sum('quantity')).order_by('-total_sold')[:5]

#     return render(request, 'sales/dashboard.html', {
#         'total_revenue': total_revenue,
#         'total_sales': total_sales,
#         'top_products': top_products
#     })



# def dashboard(request):
#     # Get filter parameters from request
#     start_date = request.GET.get('start_date')
#     end_date = request.GET.get('end_date')
#     salesperson = request.GET.get('salesperson')
#     product_name = request.GET.get('product_name')
    
#     # Start with all records
#     sales_data = SalesRecord.objects.all()
    
#     # Apply filters if they exist
#     if start_date:
#         sales_data = sales_data.filter(date_of_sale__gte=start_date)
#     if end_date:
#         sales_data = sales_data.filter(date_of_sale__lte=end_date)
#     if salesperson:
#         sales_data = sales_data.filter(salesperson=salesperson)
#     if product_name:
#         sales_data = sales_data.filter(product_name=product_name)
    
#     # Calculate total revenue for the current month
#     today = datetime.today()
#     first_day_of_month = today.replace(day=1)
#     last_day_of_month = today.replace(day=28) + timedelta(days=4)  # Make sure to go to next month
#     last_day_of_month = last_day_of_month - timedelta(days=last_day_of_month.day)  # Get the last day of the current month
    
#     # Filter sales for the current month
#     current_month_sales = sales_data.filter(date_of_sale__gte=first_day_of_month, date_of_sale__lte=last_day_of_month)
    
#     total_revenue = current_month_sales.aggregate(Sum('total_price'))['total_price__sum'] or 0
#     total_sales = current_month_sales.count()
#     top_products = current_month_sales.values('product__product_name').annotate(total_sold=Sum('quantity')).order_by('-total_sold')[:5]

#     # top_products = current_month_sales.values('product').annotate(total_sold=Sum('quantity')).order_by('-total_sold')[:5]

#     # top_products = current_month_sales.values('product_name').annotate(
#     #     total_sold=Sum('quantity')
#     # ).order_by('-total_sold')[:5]


#     salesperson_revenue = sales_data.values('salesperson').annotate(
#         revenue=Sum('total_price')
#     ).order_by('-revenue')
    
#     # Get weekly revenue for the current month
#     week_1_sales = current_month_sales.filter(date_of_sale__gte=first_day_of_month, date_of_sale__lte=first_day_of_month + timedelta(days=6))
#     week_2_sales = current_month_sales.filter(date_of_sale__gte=first_day_of_month + timedelta(days=7), date_of_sale__lte=first_day_of_month + timedelta(days=13))
#     week_3_sales = current_month_sales.filter(date_of_sale__gte=first_day_of_month + timedelta(days=14), date_of_sale__lte=first_day_of_month + timedelta(days=20))
#     week_4_sales = current_month_sales.filter(date_of_sale__gte=first_day_of_month + timedelta(days=21), date_of_sale__lte=last_day_of_month)
    
#     revenue_week_1 = week_1_sales.aggregate(Sum('total_price'))['total_price__sum'] or 0
#     revenue_week_2 = week_2_sales.aggregate(Sum('total_price'))['total_price__sum'] or 0
#     revenue_week_3 = week_3_sales.aggregate(Sum('total_price'))['total_price__sum'] or 0
#     revenue_week_4 = week_4_sales.aggregate(Sum('total_price'))['total_price__sum'] or 0
    
#     # Get unique values for filter dropdowns
#     salespeople = SalesRecord.objects.values_list('salesperson', flat=True).distinct()
#     # products = SalesRecord.objects.values_list('product', flat=True).distinct()
#     products = Product.objects.all()  # Fetch all products from the Product model


#     total_sales_data = sales_data.values('date_of_sale').annotate(sales_count=Count('id'))
#     # low_stock_products = Product.objects.filter(quantity_in_stock__lt=5)
#     low_stock_products = Product.objects.filter(quantity_in_stock__lt=5)



    
#     context = {
#         'total_revenue': total_revenue,
#         'total_sales': total_sales,
#         'top_products': top_products,
#         'salespeople': salespeople,
#         'products': products,
#         'revenue_week_1': revenue_week_1,
#         'revenue_week_2': revenue_week_2,
#         'revenue_week_3': revenue_week_3,
#         'revenue_week_4': revenue_week_4,
#         'selected_start_date': start_date,
#         'selected_end_date': end_date,
#         'selected_salesperson': salesperson,
#         'selected_product': product_name,
#         'salesperson_revenue': salesperson_revenue,  # Pass revenue breakdown
#         'total_sales_data': total_sales_data,  # Passing the total sales data
#         'low_stock_products': low_stock_products,  # Low stock products



#     }
    
#     return render(request, 'sales/dashboard.html', context)